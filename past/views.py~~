from contextlib import contextmanager

from hypergen.imports import *
from hypergen.plugins.alertify import AlertifyPlugin

from django.http import HttpResponseRedirect
from django.contrib import messages
from django.templatetags.static import static

from booking.models import Timeslot

### Templates ###

@contextmanager
def base_template():
    doctype()
    with html():
        with head():
            title(id_="page-title")
            link(href=static("chota.css"))
        with body(), div(class_="container"):
            with div(id="content"):
                yield

base_template.target_id = "content"

def free_template(timeslots_by_date):
    page_header("Book timeslot")

    with p():
        input_(id="search", oninput=callback(search, THIS))

    with table(class_="striped"):
        tr(th(x) for x in ("Date", "Time", "Doctor", "Actions"))
        for date, timeslots in timeslots_by_date:
            tr(th(date, colspan=4))
            for timeslot in timeslots:
                with tr():
                    td()
                    td(timeslot.fmt_time)
                    td(timeslot.doctor)
                    with td():
                        button("Book", class_="button primary", id=["book", timeslot.pk],
                               onclick=callback(book, timeslot.pk))

def page_header(title_):
    h1(title_)
    command("hypergen.morph", "page-title", title_)

    with nav(class_="tabs nav-center"):
        a("Book timeslot", href=free.reverse(), class_active="active")
        a("My bookings", href=booked.reverse(), class_active="active")

@contextmanager
def row():
    with div(class_="row"):
        yield

@contextmanager
def col(n):
    with div(class_=f"col-{n}"):
        yield

@contextmanager
def card(title, description):
    with div(class_="card"):
        header(h4(title))
        p(description)
        with footer(class_="is-right"):
            yield

### Liveviews ###

liveview_settings = dict(base_template=base_template, user_plugins=[AlertifyPlugin()])

@liveview(perm="booking.view_booking", **liveview_settings)  # pyright: ignore[reportGeneralTypeIssues]
def free(request):
    timeslots_by_date = Timeslot.free_by_date()
    free_template(timeslots_by_date)

@liveview(perm="booking.view_booking", **liveview_settings)  # pyright: ignore[reportGeneralTypeIssues]
def booked(request):
    page_header("My bookings")
    with row():
        for timeslot in Timeslot.objects.filter(booked_to=request.user):
            with col(4), card(timeslot, timeslot.doctor):
                button("Cancel", class_="button error", id=("book", timeslot.pk),
                       onclick=callback(cancel, timeslot.pk, confirm="Are you sure?"))

### Actions ###

@action(perm="booking.view_booking", **liveview_settings)  # pyright: ignore[reportGeneralTypeIssues]
def search(request, query):
    timeslots_by_date = Timeslot.free_by_date(query)
    free_template(timeslots_by_date)

@action(perm="booking.add_booking", **liveview_settings)  # pyright: ignore[reportGeneralTypeIssues]
def book(request, pk):
    Timeslot.book(request, pk)
    messages.add_message(request, messages.SUCCESS, "You got it!")

    return HttpResponseRedirect(booked.reverse())

@action(perm="booking.delete_booking", base_view=booked,
        **liveview_settings)  # pyright: ignore[reportGeneralTypeIssues]
def cancel(request, pk):
    Timeslot.cancel(request, pk)
    messages.add_message(request, messages.WARNING, "Your booking is gone forever!")
